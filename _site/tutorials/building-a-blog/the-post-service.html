<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>The Post Service - M3O Dev</title> <link rel="shortcut icon" href="http://0.0.0.0:4000/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="http://0.0.0.0:4000/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-70478210-5"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-70478210-5'); </script> <script type="text/javascript" src="http://0.0.0.0:4000/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="http://0.0.0.0:4000/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>The Post Service | M3O Dev</title> <meta name="generator" content="Jekyll v4.0.1" /> <meta property="og:title" content="The Post Service" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="M3O dev site - getting started, docs, tutorials and more." /> <meta property="og:description" content="M3O dev site - getting started, docs, tutorials and more." /> <link rel="canonical" href="http://0.0.0.0:4000/tutorials/building-a-blog/the-post-service" /> <meta property="og:url" content="http://0.0.0.0:4000/tutorials/building-a-blog/the-post-service" /> <meta property="og:site_name" content="M3O Dev" /> <script type="application/ld+json"> {"url":"http://0.0.0.0:4000/tutorials/building-a-blog/the-post-service","description":"M3O dev site - getting started, docs, tutorials and more.","@type":"WebPage","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/assets/images/logo.png"}},"headline":"The Post Service","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="http://0.0.0.0:4000/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="http://0.0.0.0:4000/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://0.0.0.0:4000/getting-started" class="nav-list-link">Get Started</a><ul class="nav-list "><li class="nav-list-item "><a href="http://0.0.0.0:4000/getting-started/create-services" class="nav-list-link">Create Services</a></li><li class="nav-list-item "><a href="http://0.0.0.0:4000/getting-started/invite-users" class="nav-list-link">Invite Users</a></li><li class="nav-list-item "><a href="http://0.0.0.0:4000/getting-started/private-repos" class="nav-list-link">Private Repos</a></li><li class="nav-list-item "><a href="http://0.0.0.0:4000/getting-started/public-apis" class="nav-list-link">Public APIs</a></li><li class="nav-list-item "><a href="http://0.0.0.0:4000/getting-started/using-micro" class="nav-list-link">Using Micro</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://0.0.0.0:4000/concepts" class="nav-list-link">Concepts</a><ul class="nav-list "><li class="nav-list-item "><a href="http://0.0.0.0:4000/concepts/framework" class="nav-list-link">Framework</a></li><li class="nav-list-item "><a href="http://0.0.0.0:4000/concepts/platform" class="nav-list-link">Platform</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://0.0.0.0:4000/tutorials" class="nav-list-link">Tutorials</a><ul class="nav-list "><li class="nav-list-item "><a href="http://0.0.0.0:4000/tutorials/helloworld" class="nav-list-link">Helloworld</a></li><li class="nav-list-item "><a href="http://0.0.0.0:4000/tutorials/authentication" class="nav-list-link">Authentication</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://0.0.0.0:4000/tutorials/building-a-blog" class="nav-list-link">Building A Blog</a><ul class="nav-list"><li class="nav-list-item active"> <a href="http://0.0.0.0:4000/tutorials/building-a-blog/the-post-service" class="nav-list-link active">The Post Service</a> </li></ul></li><li class="nav-list-item "><a href="http://0.0.0.0:4000/tutorials/config" class="nav-list-link">Dynamic Config</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://0.0.0.0:4000/resources" class="nav-list-link">Resources</a><ul class="nav-list "><li class="nav-list-item "><a href="http://0.0.0.0:4000/resources/community" class="nav-list-link">Community</a></li><li class="nav-list-item "><a href="http://0.0.0.0:4000/resources/development" class="nav-list-link">Development</a></li><li class="nav-list-item "><a href="http://0.0.0.0:4000/resources/support" class="nav-list-link">Support</a></li></ul></li><li class="nav-list-item"><a href="http://0.0.0.0:4000/faq" class="nav-list-link">FAQ</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search M3O Dev" aria-label="Search M3O Dev" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="http://0.0.0.0:4000/tutorials">Tutorials</a></li> <li class="breadcrumb-nav-list-item"><a href="http://0.0.0.0:4000/tutorials/building-a-blog">Building A Blog</a></li> <li class="breadcrumb-nav-list-item"><span>The Post Service</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 class="no_toc" id="the-post-service"> <a href="#the-post-service" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Post Service </h1> <h2 class="no_toc text-delta" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents </h2> <ol id="markdown-toc"> <li><a href="#the-basics" id="markdown-toc-the-basics">The Basics</a></li> <li><a href="#saving-posts" id="markdown-toc-saving-posts">Saving posts</a></li> <li><a href="#non-trivial-applications-with-key-value-stores" id="markdown-toc-non-trivial-applications-with-key-value-stores">Non-trivial applications with Key-Value stores</a></li> <li><a href="#querying-posts" id="markdown-toc-querying-posts">Querying posts</a></li> <li><a href="#deleting-posts" id="markdown-toc-deleting-posts">Deleting posts</a></li> <li><a href="#conclusions" id="markdown-toc-conclusions">Conclusions</a></li> </ol> <p>In this post we will build a post service. It will a good way to learn how to build nontrivial applications with the <a href="/getting-started#storage">Key-Value Store interface</a>.</p> <p>The most important takeaway from this post will likely be the the usage of the key-value store for non-trivial usecases (querying blog posts by slug and listing them by reverse creation order).</p> <h2 id="the-basics"> <a href="#the-basics" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Basics </h2> <p>So where to start? In the <a href="/getting-started">Getting Started guide</a> we already covered <a href="/getting-started#creating-a-service">creating a service</a>.</p> <p>Let’s use that knowledge! As a reminder, we have to make sure <code class="highlighter-rouge">micro server</code> is running in an other terminal, and we are connected to it, ie</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ micro env
* local															127.0.0.1:8081
  platform                          proxy.m3o.com
</code></pre></div></div> <p>has the local environment picked. If not, we can issue <code class="highlighter-rouge">micro env set local</code> to remedy.</p> <p>Now back to the <code class="highlighter-rouge">micro new</code> command:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ micro new posts
$ ls posts
Dockerfile	Makefile	README.md	generate.go	go.mod		handler		main.go		proto
</code></pre></div></div> <p>Great! The best way to start a service is to define the proto. The generated default should be something similar to this:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>posts<span class="p">;</span> <span class="c"># step into project root</span>
<span class="nv">$ </span><span class="nb">cat </span>proto/posts.proto 
syntax <span class="o">=</span> <span class="s2">"proto3"</span><span class="p">;</span>

package posts<span class="p">;</span>

service Posts <span class="o">{</span>
	rpc Call<span class="o">(</span>Request<span class="o">)</span> returns <span class="o">(</span>Response<span class="o">)</span> <span class="o">{}</span>
    // some more methods here...
<span class="o">}</span>

message Message <span class="o">{</span>
	string say <span class="o">=</span> 1<span class="p">;</span>
<span class="o">}</span>

message Request <span class="o">{</span>
	string name <span class="o">=</span> 1<span class="p">;</span>
<span class="o">}</span>

message Response <span class="o">{</span>
	string msg <span class="o">=</span> 1<span class="p">;</span>
<span class="o">}</span>

// some more types here...
</code></pre></div></div> <p>In our post service, we want 3 methods:</p> <ul> <li><code class="highlighter-rouge">Save</code> for blog insert and update</li> <li><code class="highlighter-rouge">Query</code> for reading and listing</li> <li><code class="highlighter-rouge">Delete</code> for deletion</li> </ul> <p>Let’s start with the post method. Modify our <code class="highlighter-rouge">proto/posts.proto</code> file to match the following:</p> <p><a name="posts-proto"></a></p> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="kn">package</span> <span class="nn">post</span><span class="p">;</span>
<span class="k">option</span> <span class="na">go_package</span> <span class="o">=</span> <span class="s">"proto;posts"</span><span class="p">;</span>

<span class="kd">service</span> <span class="n">Posts</span> <span class="p">{</span>
	<span class="k">rpc</span> <span class="n">Save</span><span class="p">(</span><span class="n">SaveRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">SaveResponse</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Post</span> <span class="p">{</span>
	<span class="kt">string</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">string</span> <span class="na">title</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">string</span> <span class="na">slug</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">string</span> <span class="na">content</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int64</span> <span class="na">timestamp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">repeated</span> <span class="kt">string</span> <span class="na">tagNames</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">message</span> <span class="nc">SaveRequest</span> <span class="p">{</span>
	<span class="n">Post</span> <span class="na">post</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">SaveResponse</span> <span class="p">{</span>
	<span class="n">Post</span> <span class="na">post</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>To regenerate the proto, we have to issue the <code class="highlighter-rouge">make proto</code> command in the project root. Let’s adjust the handler to match our proto!</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">handler</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"context"</span>

	<span class="s">"github.com/micro/micro/v3/service/logger"</span>

	<span class="n">pb</span> <span class="s">"posts/proto"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">Posts</span> <span class="k">struct</span> <span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Posts</span><span class="p">)</span> <span class="n">Save</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SaveRequest</span><span class="p">,</span> <span class="n">rsp</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SaveResponse</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="n">logger</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Received Posts.Save request"</span><span class="p">)</span>
	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now, the <code class="highlighter-rouge">main.go</code>:</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"posts/handler"</span>
	<span class="n">pb</span> <span class="s">"posts/proto"</span>

	<span class="s">"github.com/micro/micro/v3/service"</span>
	<span class="s">"github.com/micro/micro/v3/service/logger"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="c">// New Service</span>
	<span class="n">srv</span> <span class="o">:=</span> <span class="n">service</span><span class="o">.</span><span class="n">New</span><span class="p">(</span>
		<span class="n">service</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s">"posts"</span><span class="p">),</span>
		<span class="n">service</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="s">"latest"</span><span class="p">),</span>
	<span class="p">)</span>

	<span class="c">// Register Handler</span>
	<span class="n">pb</span><span class="o">.</span><span class="n">RegisterPostsHandler</span><span class="p">(</span><span class="n">srv</span><span class="o">.</span><span class="n">Server</span><span class="p">(),</span> <span class="nb">new</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">Posts</span><span class="p">))</span>

	<span class="c">// Run service</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">srv</span><span class="o">.</span><span class="n">Run</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>At this point <code class="highlighter-rouge">micro run .</code> in project root should deploy our post service. Let’s verify with <code class="highlighter-rouge">micro logs posts</code>:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ micro logs posts
Starting [service] posts
Server [grpc] Listening on [::]:53031
Registry [service] Registering node: posts-b36361ae-f2ae-48b0-add5-a8d4797508be
</code></pre></div></div> <p>(The exact output might depend on the actual config format configuraton.)</p> <h2 id="saving-posts"> <a href="#saving-posts" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Saving posts </h2> <p>Let’s make our service do something useful now: save a post. We define our model, the <code class="highlighter-rouge">Post</code> type, to match the proto and then modify the handler. The handler should now look like:</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">handler</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"context"</span>
	<span class="n">pb</span> <span class="s">"posts/proto"</span>

	<span class="s">"github.com/micro/micro/v3/service/errors"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">Posts</span> <span class="k">struct</span> <span class="p">{}</span>

<span class="k">type</span> <span class="n">Post</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">ID</span>              <span class="kt">string</span>   <span class="s">`json:"id"`</span>
	<span class="n">Title</span>           <span class="kt">string</span>   <span class="s">`json:"title"`</span>
	<span class="n">Slug</span>            <span class="kt">string</span>   <span class="s">`json:"slug"`</span>
	<span class="n">Content</span>         <span class="kt">string</span>   <span class="s">`json:"content"`</span>
	<span class="n">CreateTimestamp</span> <span class="kt">int64</span>    <span class="s">`json:"create_timestamp"`</span>
	<span class="n">UpdateTimestamp</span> <span class="kt">int64</span>    <span class="s">`json:"update_timestamp"`</span>
	<span class="n">TagNames</span>        <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:"tagNames"`</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Posts</span><span class="p">)</span> <span class="n">Save</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SaveRequest</span><span class="p">,</span> <span class="n">rsp</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SaveResponse</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Title</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Content</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s">"posts.Save"</span><span class="p">,</span> <span class="s">"ID, title or content is missing"</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div> <p>Some defensive programming never hurts to avoid confusion down the road! Not too exciting yet though. How about actually saving our post? To do that we need to understand how key-value stores work. For now, let’s just understand that we want to save the post under the key or keys we will use to retrieve it. Since UUIDs are not too nice, we will use a slug generated by the <code class="highlighter-rouge">github.com/gosimple/slug</code> library:</p> <p>(A slug is a urlified version of a title, ie. <code class="highlighter-rouge">How to Micro</code> becomes <code class="highlighter-rouge">how-to-micro</code>.)</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
	<span class="c">// other imports</span>
	<span class="s">"github.com/micro/micro/v3/service/store"</span>
	<span class="n">gostore</span> <span class="s">"github.com/micro/go-micro/v3/store"</span>
<span class="p">)</span>

<span class="c">// ...</span>

<span class="c">// Save a post</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Posts</span><span class="p">)</span> <span class="n">Save</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SaveRequest</span><span class="p">,</span> <span class="n">rsp</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SaveResponse</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Title</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Content</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s">"posts.Save"</span><span class="p">,</span> <span class="s">"ID, title or content is missing"</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">post</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Post</span><span class="p">{</span>
		<span class="n">ID</span><span class="o">:</span>              <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
		<span class="n">Title</span><span class="o">:</span>           <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Title</span><span class="p">,</span>
		<span class="n">Content</span><span class="o">:</span>         <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Content</span><span class="p">,</span>
		<span class="n">Slug</span><span class="o">:</span>            <span class="n">slug</span><span class="o">.</span><span class="n">Make</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Title</span><span class="p">),</span>
		<span class="n">TagNames</span><span class="o">:</span>        <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">TagNames</span><span class="p">,</span>
		<span class="n">CreateTimestamp</span><span class="o">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Unix</span><span class="p">(),</span>
		<span class="n">UpdateTimestamp</span><span class="o">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Unix</span><span class="p">(),</span>
	<span class="p">}</span>
	
	<span class="n">bytes</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="k">return</span> 	<span class="n">store</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gostore</span><span class="o">.</span><span class="n">Record</span><span class="p">{</span>
		<span class="n">Key</span><span class="o">:</span>   <span class="n">post</span><span class="o">.</span><span class="n">Slug</span><span class="p">,</span>
		<span class="n">Value</span><span class="o">:</span> <span class="n">bytes</span><span class="p">,</span>
	<span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div> <p>After a <code class="highlighter-rouge">micro update .</code> in project root, we can start saving posts!</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>micro posts save --post_id=1 --post_title="Post one" --post_content="First saved post"
micro posts save --post_id=2 --post_title="Post two" --post_content="Second saved post"
</code></pre></div></div> <p>WOW! We are on a roll! We’ve just saved two posts. There is one problem however. There is no way yet to get the posts out of the post service. Now luckily, <code class="highlighter-rouge">micro store</code> commands are designed to interact with the saved data. <code class="highlighter-rouge">micro store list</code> will list all keys saved (but not values):</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ micro store list --table=posts
post-one
post-two
</code></pre></div></div> <p>Why are these keys there? Remember we saved the posts by slug. Okay, but where are the values? <code class="highlighter-rouge">micro store read</code> comes to our rescue:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ micro store read --table=posts post-one
{"id":"1","title":"Post one", "content":"First saved post", "create_timestamp":1591970869, "update_timestamp":1591970869}
$ micro store read --table=posts post-two
{"id":"2","title":"Post two", "content":"Second saved post",  "create_timestamp":1591970870, "update_timestamp":1591970870}
</code></pre></div></div> <p>It’s a bit annoying however to read values one by one, that’ why the <code class="highlighter-rouge">--prefix</code> flag exists:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ micro store read --table=posts --prefix post
{"id":"1","title":"Post one", "Content":"First saved post", "create_timestamp":1591970869, "update_timestamp":1591970869}
{"id":"2","title":"Post two", "Content":"Second saved post",  "create_timestamp":1591970870, "update_timestamp":1591970870}
</code></pre></div></div> <p>And this takes us to the most important part of this post.</p> <h2 id="non-trivial-applications-with-key-value-stores"> <a href="#non-trivial-applications-with-key-value-stores" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Non-trivial applications with Key-Value stores </h2> <p>So far we saved posts by slug, but how would we go about listing post in order? As we have seen, listing by prefix gives us pretty much the only query capabilities in the key-value store (and in most other key value stores too, it’s not specific to Micro).</p> <p>So how would we go about enabling post read by slug and listing posts too? Let’s imagine the following key:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ micro store list
slug:first-post
slug:second-post
timestamp:1591970869
timestamp:1591970870
</code></pre></div></div> <p>We should also note that all records are listed in an alphabetical order of their keys. We can exploit this, coupled with the <code class="highlighter-rouge">--offset</code> and <code class="highlighter-rouge">--limit</code> concepts to implement paging, ie.</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>micro store read --table=posts --prefix --offset 0 --limit 20 post
</code></pre></div></div> <p>would give back the first 20 posts,</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>micro store read --table=posts --prefix --offset 20 --limit 20 post
</code></pre></div></div> <p>would return the second 20 posts - the second page essentially - and so on. Same applies to our post service too as with most micro interfaces the CLI commands are 1-to-1 representations of the framework features.</p> <p>Let’s get to work then and modify our <code class="highlighter-rouge">Post</code> handler. We are going to save the post under 3 different keys: under its ID, slug and create timestamp. While coming from an SQL background and being used to keeping the data model first normal form this might look weird, but key-value stores can be an insanely scalable and fast way to store information.</p> <p>This theoretical impurity and somewhat inconvenient way to handle data can enable us to scale our web application to unimaginable scales. The following code piece might be a bit longer than the previous ones, but it contains many important additions, like checking for slug changes.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="p">(</span>
	<span class="n">idPrefix</span>        <span class="o">=</span> <span class="s">"id"</span>
	<span class="n">slugPrefix</span>      <span class="o">=</span> <span class="s">"slug"</span>
	<span class="n">timestampPrefix</span> <span class="o">=</span> <span class="s">"timestamp"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Posts</span><span class="p">)</span> <span class="n">Save</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SaveRequest</span><span class="p">,</span> <span class="n">rsp</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SaveResponse</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Title</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Content</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s">"posts.Save"</span><span class="p">,</span> <span class="s">"ID, title or content is missing"</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// read by parent ID so we can check if it exists without slug changes getting in the way.</span>
	<span class="n">records</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">store</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v:%v"</span><span class="p">,</span> <span class="n">idPrefix</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Id</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">gostore</span><span class="o">.</span><span class="n">ErrNotFound</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="n">postSlug</span> <span class="o">:=</span> <span class="n">slug</span><span class="o">.</span><span class="n">Make</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Title</span><span class="p">)</span>

	<span class="c">// If no existing record is found, create a new one</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">savePost</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="no">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Post</span><span class="p">{</span>
			<span class="n">ID</span><span class="o">:</span>              <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
			<span class="n">Title</span><span class="o">:</span>           <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Title</span><span class="p">,</span>
			<span class="n">Content</span><span class="o">:</span>         <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Content</span><span class="p">,</span>
			<span class="n">TagNames</span><span class="o">:</span>        <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">TagNames</span><span class="p">,</span>
			<span class="n">Slug</span><span class="o">:</span>            <span class="n">postSlug</span><span class="p">,</span>
			<span class="n">CreateTimestamp</span><span class="o">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Unix</span><span class="p">(),</span>
		<span class="p">})</span>
	<span class="p">}</span>

	<span class="n">record</span> <span class="o">:=</span> <span class="n">records</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>

	<span class="n">oldPost</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Post</span><span class="p">{}</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">oldPost</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="n">post</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Post</span><span class="p">{</span>
		<span class="n">ID</span><span class="o">:</span>              <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span>
		<span class="n">Title</span><span class="o">:</span>           <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Title</span><span class="p">,</span>
		<span class="n">Content</span><span class="o">:</span>         <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">Content</span><span class="p">,</span>
		<span class="n">Slug</span><span class="o">:</span>            <span class="n">postSlug</span><span class="p">,</span>
		<span class="n">TagNames</span><span class="o">:</span>        <span class="n">req</span><span class="o">.</span><span class="n">Post</span><span class="o">.</span><span class="n">TagNames</span><span class="p">,</span>
		<span class="n">CreateTimestamp</span><span class="o">:</span> <span class="n">oldPost</span><span class="o">.</span><span class="n">CreateTimestamp</span><span class="p">,</span>
		<span class="n">UpdateTimestamp</span><span class="o">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Unix</span><span class="p">(),</span>
	<span class="p">}</span>

	<span class="c">// Check if slug exists</span>
	<span class="n">recordsBySlug</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">store</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v:%v"</span><span class="p">,</span> <span class="n">slugPrefix</span><span class="p">,</span> <span class="n">postSlug</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">gostore</span><span class="o">.</span><span class="n">ErrNotFound</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="n">otherSlugPost</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Post</span><span class="p">{}</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">otherSlugPost</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recordsBySlug</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="n">oldPost</span><span class="o">.</span><span class="n">ID</span> <span class="o">!=</span> <span class="n">otherSlugPost</span><span class="o">.</span><span class="n">ID</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s">"posts.Save"</span><span class="p">,</span> <span class="s">"An other post with this slug already exists"</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">savePost</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">oldPost</span><span class="p">,</span> <span class="n">post</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Posts</span><span class="p">)</span> <span class="n">savePost</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">oldPost</span><span class="p">,</span> <span class="n">post</span> <span class="o">*</span><span class="n">Post</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="n">bytes</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="c">// Save post by ID</span>
	<span class="n">record</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">gostore</span><span class="o">.</span><span class="n">Record</span><span class="p">{</span>
		<span class="n">Key</span><span class="o">:</span>   <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v:%v"</span><span class="p">,</span> <span class="n">idPrefix</span><span class="p">,</span> <span class="n">post</span><span class="o">.</span><span class="n">ID</span><span class="p">),</span>
		<span class="n">Value</span><span class="o">:</span> <span class="n">bytes</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">store</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">record</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="c">// Delete old slug index if the slug has changed</span>
	<span class="k">if</span> <span class="n">oldPost</span><span class="o">.</span><span class="n">Slug</span> <span class="o">!=</span> <span class="n">post</span><span class="o">.</span><span class="n">Slug</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">store</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v:%v"</span><span class="p">,</span> <span class="n">slugPrefix</span><span class="p">,</span> <span class="n">post</span><span class="o">.</span><span class="n">Slug</span><span class="p">));</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">err</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c">// Save post by slug</span>
	<span class="n">slugRecord</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">gostore</span><span class="o">.</span><span class="n">Record</span><span class="p">{</span>
		<span class="n">Key</span><span class="o">:</span>   <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v:%v"</span><span class="p">,</span> <span class="n">slugPrefix</span><span class="p">,</span> <span class="n">post</span><span class="o">.</span><span class="n">Slug</span><span class="p">),</span>
		<span class="n">Value</span><span class="o">:</span> <span class="n">bytes</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">store</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">slugRecord</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="c">// Save post by timeStamp</span>
	<span class="k">return</span> <span class="n">store</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gostore</span><span class="o">.</span><span class="n">Record</span><span class="p">{</span>
		<span class="c">// We revert the timestamp so the order is chronologically reversed</span>
		<span class="n">Key</span><span class="o">:</span>   <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v:%v"</span><span class="p">,</span> <span class="n">timestampPrefix</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">MaxInt64</span><span class="o">-</span><span class="n">post</span><span class="o">.</span><span class="n">CreateTimestamp</span><span class="p">),</span>
		<span class="n">Value</span><span class="o">:</span> <span class="n">bytes</span><span class="p">,</span>
	<span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div> <p>We can again invoke the Micro CLI to play around with our service after a <code class="highlighter-rouge">micro update .</code> in the project root. Let’s insert two posts through the service we wote:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>micro posts save --post_id="1" --post_title="How to Micro" --post_content="Simply put, Micro is awesome."
micro posts save --post_id="2" --post_title="Fresh posts are fresh" --post_content="This post is fresher than the How to Micro one"
</code></pre></div></div> <h2 id="querying-posts"> <a href="#querying-posts" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Querying posts </h2> <p>While we can query the data through <code class="highlighter-rouge">micro store list --table=posts</code>, we still can’t do that through the service. Implementing the <code class="highlighter-rouge">Query</code> handler will enable doing that, but first we need to amend and regenerate <a href="#posts-proto">our proto</a>. We will also define the <code class="highlighter-rouge">Delete</code> endpoint in this step so we don’t have to touch this file again soon:</p> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="kn">package</span> <span class="nn">posts</span><span class="p">;</span>
<span class="k">option</span> <span class="na">go_package</span> <span class="o">=</span> <span class="s">"proto;posts"</span><span class="p">;</span>

<span class="kd">service</span> <span class="n">Posts</span> <span class="p">{</span>
	<span class="c1">// Query currently only supports read by slug or timestamp, no listing.</span>
	<span class="k">rpc</span> <span class="n">Query</span><span class="p">(</span><span class="n">QueryRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">QueryResponse</span><span class="p">)</span> <span class="p">{}</span>
	<span class="k">rpc</span> <span class="n">Save</span><span class="p">(</span><span class="n">SaveRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">SaveResponse</span><span class="p">)</span> <span class="p">{}</span>
	<span class="k">rpc</span> <span class="n">Delete</span><span class="p">(</span><span class="n">DeleteRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">DeleteResponse</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Post</span> <span class="p">{</span>
	<span class="kt">string</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">string</span> <span class="na">title</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">string</span> <span class="na">slug</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">string</span> <span class="na">content</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int64</span> <span class="na">timestamp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">repeated</span> <span class="kt">string</span> <span class="na">tagNames</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">QueryRequest</span> <span class="p">{</span>
	<span class="kt">string</span> <span class="na">slug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int64</span> <span class="na">offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">int64</span> <span class="na">limit</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">QueryResponse</span> <span class="p">{</span>
	<span class="k">repeated</span> <span class="n">Post</span> <span class="na">posts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">SaveRequest</span> <span class="p">{</span>
	<span class="n">Post</span> <span class="na">post</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">SaveResponse</span> <span class="p">{</span>
	<span class="n">Post</span> <span class="na">post</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">DeleteRequest</span> <span class="p">{</span>
	<span class="kt">string</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">DeleteResponse</span> <span class="p">{}</span>
</code></pre></div></div> <p>A <code class="highlighter-rouge">make proto</code> issued in the command root should regenerate the Go proto files and we should be ready to define our new handler:</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Query the posts</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Posts</span><span class="p">)</span> <span class="n">Query</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">QueryRequest</span><span class="p">,</span> <span class="n">rsp</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">QueryResponse</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">var</span> <span class="n">opts</span> <span class="p">[]</span><span class="n">gostore</span><span class="o">.</span><span class="n">ReadOption</span>
	<span class="k">var</span> <span class="n">key</span> <span class="kt">string</span>

	<span class="c">// detemine the key</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Slug</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v:%v"</span><span class="p">,</span> <span class="n">slugPrefix</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">Slug</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v:"</span><span class="p">,</span> <span class="n">timestampPrefix</span><span class="p">)</span>
		<span class="n">opts</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">gostore</span><span class="o">.</span><span class="n">ReadPrefix</span><span class="p">())</span>
	<span class="p">}</span>

	<span class="c">// set the limit</span>
	<span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">Limit</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
		<span class="n">opts</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">gostore</span><span class="o">.</span><span class="n">ReadLimit</span><span class="p">(</span><span class="kt">uint</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Limit</span><span class="p">)))</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">opts</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">gostore</span><span class="o">.</span><span class="n">ReadLimit</span><span class="p">(</span><span class="m">20</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="c">// execute the query</span>
	<span class="n">records</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">store</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">opts</span><span class="o">...</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="c">// serialize the response</span>
	<span class="n">rsp</span><span class="o">.</span><span class="n">Posts</span> <span class="o">=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">Post</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">))</span>
	<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">record</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">records</span> <span class="p">{</span>
		<span class="n">postRecord</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Post</span><span class="p">{}</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">postRecord</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">err</span>
		<span class="p">}</span>

		<span class="n">rsp</span><span class="o">.</span><span class="n">Posts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">Post</span><span class="p">{</span>
			<span class="n">Id</span><span class="o">:</span>       <span class="n">postRecord</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span>
			<span class="n">Title</span><span class="o">:</span>    <span class="n">postRecord</span><span class="o">.</span><span class="n">Title</span><span class="p">,</span>
			<span class="n">Slug</span><span class="o">:</span>     <span class="n">postRecord</span><span class="o">.</span><span class="n">Slug</span><span class="p">,</span>
			<span class="n">Content</span><span class="o">:</span>  <span class="n">postRecord</span><span class="o">.</span><span class="n">Content</span><span class="p">,</span>
			<span class="n">TagNames</span><span class="o">:</span> <span class="n">postRecord</span><span class="o">.</span><span class="n">TagNames</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="c">// Delete a post</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Posts</span><span class="p">)</span> <span class="n">Delete</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">DeleteRequest</span><span class="p">,</span> <span class="n">rsp</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">DeleteResponse</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div> <p>After doing a <code class="highlighter-rouge">micro update .</code> in the project root, we can now query the posts:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ micro posts query --limit=10
{
	"posts": [
		{
			"id": "1",
			"title": "How to Micro",
			"slug": "how-to-micro",
			"content": "Simply put, Micro is awesome."
		}
	]
}
</code></pre></div></div> <p>Stellar! Now only <code class="highlighter-rouge">Delete</code> remains to be implemented to have a basic post service.</p> <h2 id="deleting-posts"> <a href="#deleting-posts" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Deleting posts </h2> <p>Since we have already defined <code class="highlighter-rouge">Delete</code> in our proto, we only have to implement the handler:</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Delete a post</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Posts</span><span class="p">)</span> <span class="n">Delete</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">DeleteRequest</span><span class="p">,</span> <span class="n">rsp</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">DeleteResponse</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="n">records</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">store</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v:%v"</span><span class="p">,</span> <span class="n">idPrefix</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">Id</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="n">gostore</span><span class="o">.</span><span class="n">ErrNotFound</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">NotFound</span><span class="p">(</span><span class="s">"posts.Delete"</span><span class="p">,</span> <span class="s">"Post not found"</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="n">post</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Post</span><span class="p">{}</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">post</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="c">// Delete by ID</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v:%v"</span><span class="p">,</span> <span class="n">idPrefix</span><span class="p">,</span> <span class="n">post</span><span class="o">.</span><span class="n">ID</span><span class="p">));</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="c">// Delete by slug</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">store</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v:%v"</span><span class="p">,</span> <span class="n">slugPrefix</span><span class="p">,</span> <span class="n">post</span><span class="o">.</span><span class="n">Slug</span><span class="p">));</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="c">// Delete by timeStamp</span>
	<span class="k">return</span> <span class="n">store</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v:%v"</span><span class="p">,</span> <span class="n">timestampPrefix</span><span class="p">,</span> <span class="n">post</span><span class="o">.</span><span class="n">CreateTimestamp</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div> <p>As it can be seen above, we had to keep in mind all the keys we inserted for a given post. We read the post by ID first to get the slug and the timetamps, ie. to know what to delete.</p> <h2 id="conclusions"> <a href="#conclusions" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Conclusions </h2> <p>This brings us to the end of the initial posts tutorial series. There are many more features we will add later, like saving and querying by tags, but this post alreadt taught us enough to digest. We will cover those aspect in later parts of this series.</p> <p>For the latest version of the code, we can consult the <a href="https://github.com/micro/services/tree/master/blog/posts">github folder of the Posts service</a>. It might contain some (or even many) additional things not covered in the post, as it is the latest version.</p> <p>Recreating the version outlined in this post is left as an exercises for the reader. Our general approach with these tutorials is to keep the snippets in the earlier posts as similar as possible to the latest version (handler names, import names, field names etc.), but reconciling the two might still prove a good exercise as the earliest versions of the services deviate from the latest one on GitHub.</p> <hr> <footer> <p class="text-small text-grey-dk-000 mb-0">Copyright &copy; 2020 Micro Services, Inc.</p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
